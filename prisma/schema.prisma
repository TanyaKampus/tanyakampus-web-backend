// IMPROVED PRISMA SCHEMA - Tanya Kampus
// Perbaikan struktur database untuk sistem quiz minat & bakat

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

enum StatusQuiz {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum TipePertanyaan {
  BIDANG        // 12 pertanyaan bidang (4 bidang × 3 soal)
  TIE_BREAKER   // 3 pertanyaan general untuk memecah seri
}

enum TipeJawaban {
  YA
  TIDAK
}

enum NamaBidang {
  TEKNIK_DAN_ILMU_KOMPUTER
  BISNIS_DAN_EKONOMI
  ILMU_SOSIAL_DAN_POLITIK
  DESAIN_DAN_SENI
}


enum TieTieBreakerType {
  EKSTROVERT_INTROVERT    // Pertanyaan 1: Ekstrovert vs Introvert
  LOGIS_INTUISI           // Pertanyaan 2: Logis vs Intuisi
  TERSTRUKTUR_BEBAS       // Pertanyaan 3: Terstruktur vs Bebas
}

// ==================== USER & PROFILE ====================
model User {
  user_id    String   @id @default(uuid())
  email      String   @unique
  password   String? 
  role       Role     @default(USER)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  profile       Profile?
  favoriteKampus   FavoriteKampus[]
  favoriteJurusan  FavoriteJurusan[]
  favoriteMentor   FavoriteMentor[]
  riwayatQuiz   RiwayatQuiz[]

  @@index([email])
}

model Profile {
  profile_id    String    @id @default(uuid())
  nama          String
  jenis_kelamin String?
  tanggal_lahir DateTime?
  foto_profil   String?
  no_telepon    String
  asal_sekolah  String
  user_id       String    @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

// ==================== MENTOR ====================
model Mentor {
  mentor_id    String   @id @default(uuid())
  nama_mentor  String
  pendidikan   String
  keahlian     String
  foto_mentor  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  favoritMentor FavoriteMentor[]
}

model FavoriteMentor {
  id        String   @id @default(uuid())
  user_id   String
  mentor_id String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  mentor Mentor @relation(fields: [mentor_id], references: [mentor_id], onDelete: Cascade)

  @@unique([user_id, mentor_id])
  @@index([user_id])
  @@index([mentor_id])
}

model FavoriteJurusan {
  id        String   @id @default(uuid())
  user_id   String
  jurusan_id String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  jurusan Jurusan @relation(fields: [jurusan_id], references: [jurusan_id], onDelete: Cascade)

  @@unique([user_id, jurusan_id])
  @@index([user_id])
  @@index([jurusan_id])
}

model FavoriteKampus {
  id        String   @id @default(uuid())
  user_id   String
  kampus_id String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  kampus Kampus @relation(fields: [kampus_id], references: [kampus_id], onDelete: Cascade)

  @@unique([user_id, kampus_id])
  @@index([user_id])
  @@index([kampus_id])
}


// ==================== BIDANG (Interest Area) ====================
model Bidang {
  bidang_id    String   @id @default(uuid())
  nama_bidang  String   @unique
  deskripsi    String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  pertanyaan    Pertanyaan[]
  jawabanBidang JawabanBidang[]
  hasilBidang   HasilBidang[]
  jurusan       Jurusan[]
}

// ==================== QUIZ SYSTEM ====================
model Quiz {
  quiz_id         String   @id @default(uuid())
  nama_quiz       String   @unique
  deskripsi_quiz  String?  @db.Text
  is_active       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  pertanyaan  Pertanyaan[]
  riwayatQuiz RiwayatQuiz[]
}

model Pertanyaan {
  pertanyaan_id String   @id @default(uuid())
  quiz_id       String
  soal          String   @db.Text
  tipe          TipePertanyaan  // BIDANG atau TIE_BREAKER
  bidang_id         String?         // Untuk tipe BIDANG, link ke bidang
  tiebreaker_type   TieTieBreakerType? // Untuk tipe TIE_BREAKER
  urutan            Int             // Urutan tampilan (1-15)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quiz         Quiz          @relation(fields: [quiz_id], references: [quiz_id], onDelete: Cascade)
  bidang       Bidang?       @relation(fields: [bidang_id], references: [bidang_id])
  jawaban      Jawaban[]
  jawabanUsers JawabanUser[]

  @@index([quiz_id])
  @@index([bidang_id])
  @@index([tipe])
}

model Jawaban {
  jawaban_id      String   @id @default(uuid())
  pertanyaan_id   String
  tipe_jawaban    TipeJawaban  // YA atau TIDAK
  nilai         Int          // 1 untuk YA, 0 untuk TIDAK
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  pertanyaan    Pertanyaan      @relation(fields: [pertanyaan_id], references: [pertanyaan_id], onDelete: Cascade)
  jawabanUsers  JawabanUser[]
  jawabanBidang JawabanBidang[] // ✅ Relasi ke bidang dengan bobot

  @@index([pertanyaan_id])
  @@unique([pertanyaan_id, tipe_jawaban]) // Hanya 2 jawaban per pertanyaan
}


// ==================== SCORING SYSTEM ====================
// Tabel ini memetakan jawaban ke bidang dengan bobot
// Untuk pertanyaan BIDANG: 1 jawaban = 1 bidang dengan bobot 1
// Untuk pertanyaan TIE_BREAKER: 1 jawaban bisa mempengaruhi 2+ bidang

model JawabanBidang {
  id         String @id @default(uuid())
  jawaban_id String
  bidang_id  String
  bobot             Int     // Bobot untuk bidang ini (biasanya 1)
  is_tiebreaker     Boolean @default(false) // Flag untuk scoring tie-breaker

  jawaban Jawaban @relation(fields: [jawaban_id], references: [jawaban_id], onDelete: Cascade)
  bidang  Bidang  @relation(fields: [bidang_id], references: [bidang_id], onDelete: Cascade)

  @@unique([jawaban_id, bidang_id]) // Satu jawaban hanya punya 1 bobot per bidang
  @@index([jawaban_id])
  @@index([bidang_id])
}

model JawabanUser {
  jwbuser_id    String   @id @default(uuid())
  riwayat_id    String   // ✅ Link ke riwayat quiz, bukan langsung ke user
  pertanyaan_id String
  jawaban_id    String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  riwayat    RiwayatQuiz @relation(fields: [riwayat_id], references: [riwayat_id], onDelete: Cascade)
  pertanyaan Pertanyaan  @relation(fields: [pertanyaan_id], references: [pertanyaan_id], onDelete: Cascade)
  jawaban    Jawaban     @relation(fields: [jawaban_id], references: [jawaban_id], onDelete: Cascade)

  @@unique([riwayat_id, pertanyaan_id]) // Satu pertanyaan hanya bisa dijawab 1x per attempt
  @@index([riwayat_id])
  @@index([pertanyaan_id])
}

// ==================== HASIL & RIWAYAT ====================
// ✅ IMPROVED: Gabungkan Hasil dan RiwayatQuiz jadi satu tabel
model RiwayatQuiz {
  riwayat_id     String      @id @default(uuid())
  user_id        String
  quiz_id        String
  status_quiz    StatusQuiz  @default(IN_PROGRESS)
  tanggal_mulai  DateTime    @default(now())
  tanggal_selesai DateTime?
  bidang_terpilih String?     // Bidang pemenang setelah scoring
  used_tiebreaker Boolean     @default(false) // Apakah menggunakan tie-breaker
  total_skor     Int         @default(0)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  user          User            @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  quiz          Quiz            @relation(fields: [quiz_id], references: [quiz_id], onDelete: Cascade)
  jawabanUsers  JawabanUser[]
  hasilBidang   HasilBidang[]
  hasilJurusan  HasilJurusan[]
  hasilKampus   HasilKampus[]

  @@index([user_id])
  @@index([quiz_id])
  @@index([user_id, quiz_id])
  @@index([status_quiz])
}

model HasilBidang {
  id          String @id @default(uuid())
  riwayat_id  String
  bidang_id   String
  skor_bidang Int      // Skor dari 12 pertanyaan bidang (max 3)
  skor_tiebreaker   Int      @default(0) // Skor tambahan dari tie-breaker
  skor_total        Int      // skor_bidang + skor_tiebreaker
  persentase        Float?   // Persentase dari total skor
  is_winner         Boolean  @default(false) // Bidang pemenang
  createdAt   DateTime @default(now())

  riwayat RiwayatQuiz @relation(fields: [riwayat_id], references: [riwayat_id], onDelete: Cascade)
  bidang  Bidang      @relation(fields: [bidang_id], references: [bidang_id], onDelete: Cascade)

  @@unique([riwayat_id, bidang_id])
  @@index([riwayat_id])
  @@index([bidang_id])
}

// ==================== JURUSAN & KAMPUS ====================
model Jurusan {
  jurusan_id     String   @id @default(uuid())
  nama_jurusan   String   @unique
  deskripsi      String?  @db.Text
  bidang_id      String?  // ✅ Link jurusan ke bidang utama
  icon           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  bidang         Bidang?         @relation(fields: [bidang_id], references: [bidang_id])
  jurusanKampus  JurusanKampus[]
  hasilJurusan   HasilJurusan[]
  favoriteJurusan  FavoriteJurusan[]

  @@index([bidang_id])
  @@index([nama_jurusan])
}

model JurusanKampus {
  id          String @id @default(uuid())
  kampus_id   String
  jurusan_id  String

  kampus  Kampus  @relation(fields: [kampus_id], references: [kampus_id], onDelete: Cascade)
  jurusan Jurusan @relation(fields: [jurusan_id], references: [jurusan_id], onDelete: Cascade)

  @@unique([kampus_id, jurusan_id])
  @@index([kampus_id])
  @@index([jurusan_id])
}

model HasilJurusan {
  id          String @id @default(uuid())
  riwayat_id  String
  jurusan_id  String
  skor_match  Float? // Skor kecocokan (0-100)
  rank        Int?   // Ranking rekomendasi

  riwayat RiwayatQuiz @relation(fields: [riwayat_id], references: [riwayat_id], onDelete: Cascade)
  jurusan Jurusan     @relation(fields: [jurusan_id], references: [jurusan_id], onDelete: Cascade)

  @@unique([riwayat_id, jurusan_id])
  @@index([riwayat_id])
  @@index([jurusan_id])
}

model Kampus {
  kampus_id        String   @id @default(uuid())
  nama_kampus      String   @unique
  jenis_kampus     String   // Negeri, Swasta, Kedinasan
  deskripsi_kampus String?  @db.Text
  foto_kampus      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  jurusanKampus JurusanKampus[]
  hasilKampus   HasilKampus[]
  favoriteKampus FavoriteKampus[]
}

model HasilKampus {
  id          String @id @default(uuid())
  riwayat_id  String
  kampus_id   String
  skor_match  Float? // Skor kecocokan
  rank        Int    // Ranking rekomendasi



  riwayat RiwayatQuiz @relation(fields: [riwayat_id], references: [riwayat_id], onDelete: Cascade)
  kampus  Kampus      @relation(fields: [kampus_id], references: [kampus_id], onDelete: Cascade)

  @@unique([riwayat_id, kampus_id])
  @@index([riwayat_id])
  @@index([kampus_id])
}